<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Quản Lý Sinh Viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light">
    <div class="container-fluid py-5">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between">
                <h4 class="text-primary mb-0">DANH SÁCH SINH VIÊN</h4>
                <button class="btn btn-primary" onclick="showAddSVModal()">+ Thêm Sinh Viên</button>
            </div>
            <div class="card-body">
                <input type="text" id="search" class="form-control mb-3" placeholder="Tìm theo tên, mã SV hoặc lớp...">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered align-middle">
                        <thead class="table-dark text-center">
                            <tr>
                                <th>ID</th>
                                <th>Mã SV</th>
                                <th>Họ Tên</th>
                                <th>Ngày Sinh</th>
                                <th>Phái</th>
                                <th>Lớp</th>
                                <th>Email</th>
                                <th>Số điện thoại</th>
                                <th>Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="svTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSV" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thông Tin Sinh Viên</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="idSV">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Mã Sinh Viên</label>
                            <input type="text" id="maSV" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Họ Tên</label>
                            <input type="text" id="hoTen" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Ngày Sinh</label>
                            <input type="date" id="ngaySinh" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Giới Tính</label>
                            <select id="gioiTinh" class="form-select">
                                <option value="Nam">Nam</option>
                                <option value="Nu">Nữ</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Lớp Học</label>
                            <select id="selectLop" class="form-select"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" id="email" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Số điện thoại</label>
                            <input type="text" id="sdt" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" id="btnSaveSV" class="btn btn-success">Lưu Dữ Liệu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            loadSinhVien();
            loadLopDropdown();

            function loadSinhVien() {
                $.post("sinh_vien_api.php", { action: "fetch_sinh_vien" }, function (data) {
                    let rows = "";
                    let items = JSON.parse(data);
                    $.each(items, function (i, v) {
                        rows += `
                        <tr>
                            <td class="text-center">${v.id}</td>
                            <td>${v.ma_sinh_vien}</td>
                            <td class="fw-bold">${v.ho_ten}</td>
                            <td>${v.ngay_sinh}</td>
                            <td class="text-center">${v.gioi_tinh == 'Nam' ? 'Nam' : 'Nữ'}</td>
                            <td><span class="badge bg-primary">${v.ten_lop || 'N/A'}</span></td>
                            <td>${v.email}</td>
                            <td>${v.so_dien_thoai}</td>
                            <td class="text-center">
                                <button class="btn btn-warning btn-sm btnEdit" 
                                    data-id="${v.id}" data-ma="${v.ma_sinh_vien}" data-ten="${v.ho_ten}" 
                                    data-ngay="${v.ngay_sinh}" data-gt="${v.gioi_tinh}" 
                                    data-lop="${v.lop_id}" data-mail="${v.email}" data-sdt="${v.so_dien_thoai}">Sửa</button>
                                <button class="btn btn-danger btn-sm btnDelete" data-id="${v.id}">Xóa</button>
                            </td>
                        </tr>`;
                    });
                    $("#svTableBody").html(rows);
                });
            }

            function loadLopDropdown() {
                $.post("sinh_vien_api.php", { action: "fetch_lop_list" }, function (data) {
                    let options = '<option value="">-- Chọn Lớp --</option>';
                    $.each(JSON.parse(data), function (i, v) {
                        options += `<option value="${v.id}">${v.ten_lop}</option>`;
                    });
                    $("#selectLop").html(options);
                });
            }

            $("#btnSaveSV").click(function () {
                let id = $("#idSV").val();
                let action = id ? "update" : "insert";
                $.post("sinh_vien_api.php", {
                    action: action, id: id,
                    ma_sinh_vien: $("#maSV").val(),
                    ho_ten: $("#hoTen").val(),
                    ngay_sinh: $("#ngaySinh").val(),
                    gioi_tinh: $("#gioiTinh").val(),
                    lop_id: $("#selectLop").val(),
                    email: $("#email").val(),
                    so_dien_thoai: $("#sdt").val()
                }, function () {
                    $("#modalSV").modal("hide");
                    loadSinhVien();
                });
            });

            $(document).on("click", ".btnEdit", function () {
                $("#idSV").val($(this).data("id"));
                $("#maSV").val($(this).data("ma"));
                $("#hoTen").val($(this).data("ten"));
                $("#ngaySinh").val($(this).data("ngay"));
                $("#gioiTinh").val($(this).data("gt"));
                $("#selectLop").val($(this).data("lop"));
                $("#email").val($(this).data("mail"));
                $("#sdt").val($(this).data("sdt"));
                $(".modal-title").text("Chỉnh Sửa Sinh Viên");
                $("#modalSV").modal("show");
            });

            $(document).on("click", ".btnDelete", function () {
                if (confirm("Xóa sinh viên này sẽ mất vĩnh viễn dữ liệu điểm số. Tiếp tục?")) {
                    $.post("sinh_vien_api.php", { action: "delete", id: $(this).data("id") }, function () {
                        loadSinhVien();
                    });
                }
            });

            $("#search").on("keyup", function () {
                let value = $(this).val().toLowerCase();
                $("#svTableBody tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });

        function showAddSVModal() {
            $("#idSV").val("");
            $("#maSV").val(""); $("#hoTen").val(""); $("#ngaySinh").val("");
            $("#email").val(""); $("#sdt").val(""); $("#selectLop").val("");
            $(".modal-title").text("Thêm Sinh Viên Mới");
            $("#modalSV").modal("show");
        }
    </script>
</body>

</html>